version: 2.1

jobs:
  devsecops-scan:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/repo
    steps:
      - checkout

      # Install Frontend dependencies
      - run:
          name: Install Frontend Dependencies
          command: |
            cd Frontend
            npm ci

      # Install Backend dependencies
      - run:
          name: Install Backend Dependencies
          command: |
            cd Backend
            npm ci

      # Software Composition Analysis
      - run:
          name: Frontend npm audit
          command: |
            cd Frontend
            npm audit --audit-level=high || true
      - run:
          name: Backend npm audit
          command: |
            cd Backend
            npm audit --audit-level=high || true

      # Optional Linting (warnings only, not failing build)
      - run:
          name: Frontend ESLint (warnings)
          command: |
            cd Frontend
            npm install --no-save eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
            npx eslint "src/**/*.{js,ts,tsx}" || true
      - run:
          name: Backend ESLint (warnings)
          command: |
            cd Backend
            npm install --no-save eslint eslint-plugin-security
            npx eslint "**/*.js" --plugin security || true

      # Simple API / Smoke Test
      - run:
          name: Backend Smoke Test
          command: |
            cd Backend
            npm install --no-save node-fetch@3
            node scripts/smoke-test.js || true

      # SonarQube / SonarCloud Scan (Hotspots + Code Smells)
      - run:
          name: SonarQube Scan
          command: |
            echo "Setting up Sonar Scanner CLI..."
            export SONAR_SCANNER_VERSION=5.0.1.3006
            export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
            mkdir -p $HOME/.sonar
            curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
            unzip -q -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
            export PATH=$SONAR_SCANNER_HOME/bin:$PATH
            sonar-scanner \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.projectBaseDir=. \
              -Dsonar.sources=Frontend,Backend \
              -Dsonar.working.directory=.sonar \
              -Dsonar.verbose=true

workflows:
  version: 2
  devsecops-pipeline:
    jobs:
      - devsecops-scan
