version: 2.1

jobs:
  build-and-analyze:
    docker:
      - image: cimg/node:18.17
    steps:
      - checkout

      # --------------------------
      # 1️⃣ Install dependencies
      # --------------------------
      - run:
          name: Install Frontend dependencies
          command: cd Frontend && npm ci
      - run:
          name: Install Backend dependencies
          command: cd Backend && npm ci

      # --------------------------
      # 2️⃣ Software Composition Analysis
      # --------------------------
      - run:
          name: Frontend npm audit
          command: cd Frontend && npm audit --audit-level=moderate || true
      - run:
          name: Backend npm audit
          command: cd Backend && npm audit --audit-level=moderate || true

      # --------------------------
      # 3️⃣ Start backend server for smoke testing
      # --------------------------
      - run:
          name: Start Backend Server
          command: |
            cd Backend
            nohup node server.js &
            echo "Waiting for server to be ready..."
            for i in {1..15}; do
              if nc -z localhost 5400; then
                echo "Server is up"
                break
              fi
              sleep 1
            done

      # --------------------------
      # 4️⃣ Basic API smoke test
      # --------------------------
      - run:
          name: Backend API smoke test
          command: |
            cd Backend
            if [ -f scripts/smoke-test.js ]; then
              echo "Running API smoke test..."
              node scripts/smoke-test.js
            else
              echo "No smoke-test.js found, skipping."
            fi

      # --------------------------
      # 5️⃣ Run SonarCloud Scan
      # --------------------------
      - run:
          name: Run SonarCloud Scan
          command: |
            echo "Downloading and running Sonar Scanner CLI..."
            export SONAR_SCANNER_VERSION=5.0.1.3006
            export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
            mkdir -p $HOME/.sonar
            curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
            unzip -q -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
            export PATH=$SONAR_SCANNER_HOME/bin:$PATH
            sonar-scanner \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.projectBaseDir=. \
              -Dsonar.working.directory=.sonar \
              -Dsonar.verbose=true

workflows:
  version: 2
  build_and_scan:
    jobs:
      - build-and-analyze
