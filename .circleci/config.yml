name: DevSecOps Pipeline

on:
  push:
    branches:
      - main
      - 'feature/*'

jobs:
  devsecops:
    name: DevSecOps Pipeline
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Setup Node.js environment
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4️⃣ Static Application Security Testing (SAST)
      - name: Run ESLint Security Checks
        run: |
          npm install eslint eslint-plugin-security --save-dev
          npx eslint . --ext .js,.ts

      - name: Run NodeJsScan for Static Analysis
        uses: neutretech/nodejs-scan-action@v1
        with:
          args: .

      # 5️⃣ Software Composition Analysis (SCA)
      - name: Run Snyk for Dependency Vulnerabilities
        uses: snyk/actions/node@v1.0.3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: test

      # 6️⃣ API Security Testing
      - name: Install API Testing Tools
        run: npm install -g newman

      - name: Run Postman API Tests
        run: |
          newman run ./postman_collection.json \
          --env-var "BASE_URL=http://localhost:3000"

      # 7️⃣ Optional: Containerize & run additional research tools (e.g., OWASP ZAP)
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: './zap_rules.yml'
