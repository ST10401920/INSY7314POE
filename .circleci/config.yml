version: 2.1

jobs:
  build-and-analyze:
    docker:
      - image: cimg/node:18.18
    steps:
      - checkout

      # --------------------------
      # Install dependencies
      # --------------------------
      - run: cd Frontend && npm ci
      - run: cd Backend && npm ci

      # --------------------------
      # Static Application Security Testing (SAST)
      # --------------------------
      - run: cd Backend && npx eslint "**/*.js" --plugin security || true
      - run: cd Frontend && npx eslint "**/*.js" --plugin security || true

      # --------------------------
      # Software Composition Analysis (SCA)
      # --------------------------
      - run: cd Frontend && npm audit --audit-level=high || exit 1
      - run: cd Backend && npm audit --audit-level=high || exit 1

      # --------------------------
      # Run Jest Tests & Generate Coverage
      # --------------------------
      - run: cd Backend && npx jest --coverage
      - run: cd Frontend && npx jest --coverage

      # --------------------------
      # SonarCloud Scan
      # --------------------------
      - run: |
          export SONAR_SCANNER_VERSION=5.0.1.3006
          export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
          mkdir -p $HOME/.sonar
          curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
          unzip -q -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
          export PATH=$SONAR_SCANNER_HOME/bin:$PATH
          sonar-scanner \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.projectBaseDir=. \
            -Dsonar.working.directory=.sonar \
            -Dsonar.javascript.lcov.reportPaths=Backend/coverage/lcov.info,Frontend/coverage/lcov.info \
            -Dsonar.exclusions=Backend/tests/helpers/*,Frontend/tests/helpers/* \
            -Dsonar.verbose=true

workflows:
  version: 2
  build_and_scan:
    jobs:
      - build-and-analyze
