version: 2.1

jobs:
  build-and-analyze:
    docker:
      - image: cimg/node:18.17
    working_directory: ~/repo
    steps:
      - checkout

      # ----------------------------
      # Install dependencies
      # ----------------------------
      - run:
          name: Install Frontend dependencies
          command: cd Frontend && npm ci
      - run:
          name: Install Backend dependencies
          command: cd Backend && npm ci

      # ----------------------------
      # Software Composition Analysis (dependency vulnerabilities)
      # ----------------------------
      - run:
          name: Frontend npm audit
          command: cd Frontend && npm audit --audit-level=high || true
      - run:
          name: Backend npm audit
          command: cd Backend && npm audit --audit-level=high || true

      # ----------------------------
      # Static code analysis (lint)
      # ----------------------------
      - run:
          name: Lint Frontend
          command: cd Frontend && npx eslint src --ext .js,.jsx,.ts,.tsx || true
      - run:
          name: Lint Backend
          command: cd Backend && npx eslint . --ext .js,.ts --plugin security || true

      # ----------------------------
      # Simple API / Smoke test (mock server)
      # ----------------------------
      - run:
          name: Backend API smoke test
          command: |
            cd Backend
            # Use Node-fetch v3 (ESM)
            node -e "
            import fetch from 'node-fetch';
            import http from 'http';

            // Simple mock server
            const server = http.createServer((req, res) => {
              if (req.url === '/health') {
                res.writeHead(200, {'Content-Type': 'application/json'});
                res.end(JSON.stringify({status: 'ok'}));
              } else {
                res.writeHead(404);
                res.end();
              }
            });
            server.listen(3000, async () => {
              console.log('Mock server running on port 3000');
              try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                if (data.status !== 'ok') {
                  console.error('API test failed!');
                  process.exit(1);
                }
                console.log('API test passed!');
              } catch (err) {
                console.error('API test failed:', err);
                process.exit(1);
              } finally {
                server.close();
              }
            });
            "

      # ----------------------------
      # SonarQube Scan (Hotspots + Code Smells)
      # ----------------------------
      - run:
          name: Run SonarCloud Scan
          command: |
            echo "Downloading and running Sonar Scanner CLI..."
            export SONAR_SCANNER_VERSION=5.0.1.3006
            export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
            mkdir -p $HOME/.sonar
            curl -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
            unzip -q -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
            export PATH=$SONAR_SCANNER_HOME/bin:$PATH
            sonar-scanner \
              -Dsonar.login=$SONAR_TOKEN \
              -Dsonar.projectBaseDir=. \
              -Dsonar.sources=Frontend,Backend \
              -Dsonar.working.directory=.sonar \
              -Dsonar.verbose=true

workflows:
  version: 2
  build_and_scan:
    jobs:
      - build-and-analyze
